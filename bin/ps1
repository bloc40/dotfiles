#!/bin/sh

RED=31m
GREEN=32m
CLEAR="\[\e[0m\]"
YELLOW="\[\e[33m\]"
MAGENTA="\[\e[35m\]"
BLUE_BG="\[\e[44m\]"

__git_repo() {
  [[ `git rev-parse --is-inside-work-tree 2>/dev/null` == true ]]
}

__git_modified() {
  [[ `git ls-files -m` != '' ]]
}

__git_untracked() {
  [[ `git ls-files -o --exclude-standard` != '' ]]
}

__git_staged() {
  [[ `git diff --staged --name-only` != '' ]]
}

__git_dirty() {
  __git_modified || __git_untracked || __git_staged
}

__git_branch_color() {
  if __git_repo && __git_dirty; then
    echo $RED
  else
    echo $GREEN
  fi
}

__git_branch() {
  git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/(\1) /'
}

__command_state() {
  echo "\$(if [[ \$? == 0 ]]; then echo \"\[\e[$GREEN\]âœ” \"; else echo \"\[\e[$RED\]âœ˜ \"; fi)$CLEAR"
}

__show_jobs() {
  if [[ `jobs` != '' ]]; then
    count=`jobs | wc -l | awk '{print $1}'`
    echo " [ðŸ‘»- $count]"
  fi
}

__tmux_sessions() {
  if [[ `tmux ls 2> /dev/null` != '' ]]; then
    count=`tmux ls | wc -l | awk '{print $1}'`
    echo " [tmux $count]"
  fi
}
__ruby_version() {
  if [[ `which rvm` != '' ]]; then
    echo `~/.rvm/bin/rvm-prompt`
  elif [[ `which rbenv` != '' ]]; then
    echo `rbenv version | awk '{print $1}'`
  else
    echo `ruby version | awk '{print $2}'`
  fi
}

__print_pre_prompt() {
  printf "\e[1;34m%$(($COLUMNS))s" $(__ruby_version)
}

PROMPT_COMMAND=__print_pre_prompt
export PS1="$(__command_state)$BLUE_BG\w$CLEAR$YELLOW\$(__show_jobs)$MAGENTA\$(__tmux_sessions) \[\e[\$(__git_branch_color)\]\$(__git_branch)$CLEAR"
