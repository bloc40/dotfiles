#!/bin/sh

RED=31m
GREEN=32m
CLEAR="\[\e[0m\]"
YELLOW="\[\e[33m\]"
MAGENTA="\[\e[35m\]"
BLUE_BG="\[\e[44m\]"

_git_repo() {
  [[ `git rev-parse --is-inside-work-tree 2>/dev/null` == true ]]
}

_git_modified() {
  [[ `git ls-files -m` != '' ]]
}

_git_untracked() {
  [[ `git ls-files -o --exclude-standard` != '' ]]
}

_git_staged() {
  [[ `git diff --staged --name-only` != '' ]]
}

_git_dirty() {
  _git_modified || _git_untracked || _git_staged
}

git_branch_color() {
  if _git_repo && _git_dirty; then
    echo $RED
  else
    echo $GREEN
  fi
}

git_branch() {
  git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/(\1) /'
}

command_state() {
  echo "\$(if [[ \$? == 0 ]]; then echo \"\[\e[$GREEN\]âœ”\"; else echo \"\[\e[$RED\]âœ˜\"; fi)$CLEAR"
}

show_jobs() {
  if [[ `jobs` != '' ]]; then
    count=`jobs | wc -l | awk '{print $1}'`
    echo " [ðŸ‘»- $count]"
  fi
}

tmux_sessions() {
  if [[ `tmux ls 2> /dev/null` != '' ]]; then
    count=`tmux ls | wc -l | awk '{print $1}'`
    echo " [tmux $count]"
  fi
}

_ruby_version() {
  if [[ `which rvm` != '' ]]; then
    echo `~/.rvm/bin/rvm-prompt`
  elif [[ `which rbenv` != '' ]]; then
    echo `rbenv version | awk '{print $1}'`
  else
    echo `ruby version | awk '{print $2}'`
  fi
}

_node_version() {
  echo "node-`node -v`"
}

print_pre_prompt() {
  printf "\e[1;30m%$(($COLUMNS))s" $(_ruby_version)/$(_node_version)
}

PROMPT_COMMAND=print_pre_prompt
export PS1="$(command_state) $BLUE_BG\w$CLEAR$YELLOW\$(show_jobs)$MAGENTA\$(tmux_sessions) \[\e[\$(git_branch_color)\]\$(git_branch)$CLEAR"
