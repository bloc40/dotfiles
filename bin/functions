#!/bin/zsh

# =======================================
#  create folder and cd to it immediately
# =======================================
take() {
  mkdir -pv $1 && cd $1;
}

# ====================
# find process by name
# ====================
jps() {
  ps ax | ag $@
}

# =======================
# kill process(s) by name
# =======================
jkill() {
  local process=$@
  ps ax | grep "$process" | grep -v grep | awk '{print $1}' | xargs kill -9
}

# ==================
# most used commands
# ==================
most() {
  history | awk '{print $2}' | sort | uniq -c | sort -rn | head
}

colors() {
  for i in {0..255}; do printf "\x1b[38;5;${i}mcolor${i}\x1b[0m\n"; done
}

# =========================================
# create a TMUX session for a Rails project
# =========================================
tat() {
  dir=${PWD##*/}

  # attach if session already exists
  if tmux has-session -t $dir 2>/dev/null; then
    tmux attach -t $dir
    return
  fi

  # create new session with Vim window
  tmux new-session -s "$dir" -n Vim -d
  tmux send-keys -t $dir:Vim 'nvim .' C-m

  # Console window
  tmux new-window -t $dir -n Console
  tmux send-keys -t $dir:Console 'bin/rails c' C-m

  # Server window
  tmux new-window -t $dir -n Server
  tmux send-keys -t $dir:Server 'bin/rails s' C-m

  # Logs window
  tmux new-window -t $dir -n Logs
  tmux send-keys -t $dir:Logs 'tail -f log/development.log' C-m

  # start in Vim window
  tmux select-window -t $dir:Vim
  tmux attach -t $dir
}


# =====================================================================
# Start an HTTP server from a directory, optionally specifying the port
# =====================================================================
server() {
  if [[ "$1" == "-p" || "$1" == "--port" ]]; then
    PORT="$2"

    if [[ "$PORT" =~ ^[0-9]{4}$ ]]; then
      python3 -m http.server $PORT;
    else
      python3 -m http.server 8000;
    fi
  elif [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "Usage: server -p <4-digit port> | --port <4-digit port>"
  else
    python3 -m http.server 8000;
  fi
}

# =====================================================================
# Disable saving to history file
# =====================================================================
privacy_on() {
  export HISTFILE=/dev/null
  export HISTSIZE=0
  export SAVEHIST=0
  unsetopt INC_APPEND_HISTORY
  unsetopt SHARE_HISTORY
}

privacy_off() {
  export HISTFILE=~/.zsh_history
  export HISTSIZE=5000
  export SAVEHIST=5000
  setopt INC_APPEND_HISTORY
  setopt SHARE_HISTORY
}
